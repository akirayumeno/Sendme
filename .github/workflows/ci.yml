name: CI / Backend Tests

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install Ruff
        run: pip install ruff
      - name: Run Ruff Check
        run: ruff check .

  unit-tests:
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov
      - name: Run Unit Tests
        env:
          DATABASE_URL: "sqlite:///:memory:"
          JWT_SECRET: "test-secret-key"
        run: pytest tests/unit --cov=app --cov-report=xml

  integration-tests:
    needs: unit-tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Start Services (DB & Redis)
        # initiate database and Redis container
        run: docker compose up -d db redis

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest alembic psycopg2-binary

      - name: Wait for Postgres
        run: |
          until docker compose exec db pg_isready -U postgres; do
            echo "Waiting for database..."
            sleep 2
          done

      - name: Run Alembic Migrations
        env:
          DATABASE_URL: "postgresql://postgres:password@localhost:5432/db"
        run: alembic upgrade head

      - name: Run Integration Tests
        env:
          DATABASE_URL: "postgresql://postgres:password@localhost:5432/db"
          REDIS_URL: "redis://localhost:6379/0"
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: pytest tests/integration

  coverage:
    needs: [ unit-tests ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: true